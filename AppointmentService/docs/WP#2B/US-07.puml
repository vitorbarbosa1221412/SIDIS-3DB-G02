@startuml
actor "Patient" as patient
participant "AppointmentController" as controller
participant "AppointmentService" as service
participant "PhysicianService" as physicianService
participant "PatientService" as patientService
participant "AppointmentRepository" as appointmentRepo
participant "AppointmentRecordService" as recordService
database "Database" as db

patient -> controller: POST /api/appointments\n(AppointmentRequest)
activate controller
note left: AppointmentRequest contÃ©m:\n- physicianId\n- dateTime\n- consultationType

controller -> patientService: getCurrentPatient()
activate patientService
patientService --> controller: loggedInPatient
deactivate patientService

controller -> service: createAppointment(AppointmentRequest, Patient)
activate service

service -> physicianService: getPhysician(physicianId)

physicianService --> service: physician
deactivate physicianService

service -> recordService: checkPhysicianAvailability\n(physician, dateTime)

recordService -> appointmentRepo: findByPhysicianAndDateTime\n(physician, dateTime)

appointmentRepo -> db: SELECT * FROM appointments\nWHERE physician_id = ?\nAND date_time = ?

db --> appointmentRepo: result

appointmentRepo --> recordService: existingAppointment


alt physician is not available
    recordService --> service: false
    service --> controller: throw PhysicianNotAvailableException
    controller --> patient: HTTP 409 Conflict\n(Physician not available)
else physician is available
    recordService --> service: true

    service -> service: createNewAppointment\n(patient, physician, dateTime, type)

    service -> appointmentRepo: save(appointment)

    appointmentRepo -> db: INSERT INTO appointments

    db --> appointmentRepo: savedAppointment

    appointmentRepo --> service: savedAppointment

    service --> controller: savedAppointment

    controller --> patient: HTTP 201 Created\n(Appointment details)
end
deactivate controller

@enduml
