@startuml PhysicianServiceCQRS_V2

title Physician Service Internal Architecture (CQRS & Saga)

' Skinparam for visual styling
skinparam defaultTextAlignment center
skinparam databaseBackgroundColor #FFCC99
skinparam queueBackgroundColor #98FB98
skinparam rectangle {
    BackgroundColor White
    BorderColor #1D70B8
    FontColor Black
    StereotypeFontColor #1D70B8
    Shadowing true
    roundCorner 15
}
skinparam component {
    FontSize 14
    Padding 10
}


rectangle "Physician Service Bounded Context" as SVC_P <<Microservice x2>> {

    rectangle "WRITE SIDE (COMMAND & SAGA CONSUMER)" as WriteSide {
        component "1. REST API" as CommandAPI <<POST /reserve-slot>>
        component "2. Saga Listener" as SagaListener <<AMQP: ApptRequestedEvent>>
        component "3. Command Handler" as CmdHandler
        component "4. Domain Model" as DomainModel <<Aggregate: Schedule>>
        database "5. Write DB" as WriteDB <<PostgreSQL (ACID)>>
    }

    rectangle "READ SIDE (QUERY)" as ReadSide {
        component "6. Query API" as QueryAPI <<GET /available-slots>>
        component "7. Query Service" as QueryService <<Availability Queries>>
        database "8. Read DB" as ReadDB <<MongoDB / View>>
    }

    component "9. Event Publisher" as EventPublisher <<RabbitTemplate>>
    queue "10. RabbitMQ" as Broker <<Event Bus>>

    ' Relações de Tráfego
    CommandAPI --> CmdHandler : "Executes Command"
    QueryAPI --> QueryService : "Executes Query"

    ' Fluxo de Escrita (REST ou Saga)
    SagaListener --> CmdHandler : "Consumes Event"
    CmdHandler --> DomainModel : "Applies Rules (Tx Local)"
    DomainModel --> WriteDB : "Persist State"
    DomainModel --> EventPublisher : "Generates Saga Event"
    EventPublisher --> Broker : "Publishes SlotReservedEvent / ReservationFailedEvent"

    ' Fluxo de Leitura (CQRS)
    QueryService --> ReadDB : "Fetches Denormalized View"

    ' Sincronização CQRS
    Broker --> ReadDB : "Updates Read Model Asynchronously"
}

@enduml