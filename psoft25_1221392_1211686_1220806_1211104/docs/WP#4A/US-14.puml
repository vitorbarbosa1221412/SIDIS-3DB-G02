@startuml
title US-14: As a Physician I want to record appointment details after a consultation

autonumber
autoactivate on

actor "Physician" as physician
participant "AppointmentAPI" as api
participant "AppointmentRecordService" as service
participant "Mapper: AppointmentRecordMapper" as mapper
participant "ViewMapper: AppointmentRecordViewMapper" as viewMapper
participant "repo: AppointmentRepository" as appointmentRepo
participant "repo: AppointmentRecordRepository" as recordRepo
participant "obj: Appointment" as appointment
participant "obj: AppointmentRecord" as record
participant "Security: AuthContext" as auth


physician -> api : POST /appointments/{id}/record\nAuthorization: AppointmentRecordDTO
api -> auth : getAuthenticatedUser()
auth --> api : PhysicianUserDetails

api -> service : recordAppointmentDetails(appointmentId, dto, authenticatedUser)


service -> appointmentRepo : findById(appointmentId)
appointmentRepo --> service : Optional<Appointment>
service -> service : validatePhysicianOwnership(appointment, authenticatedUser)


service -> mapper : toEntity(dto)
mapper --> record : AppointmentRecord(diagnosis, prescription, treatmentRecommendation)
mapper --> service : record

service -> record : setAppointment(appointment)
record --> service : ok


service -> recordRepo : save(record)
recordRepo --> service : savedRecord


service -> viewMapper : toDTO(savedRecord)
viewMapper --> service : AppointmentRecordViewDTO
service --> api : AppointmentRecordViewDTO
api --> physician : HTTP 201 Created + body(AppointmentRecordViewDTO)

@enduml
